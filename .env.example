# happy-stacks environment (template)
#
# Copy to `.env` (recommended) and adjust as needed:
#
#   cp .env.example .env
#
# Notes:
# - `HAPPY_STACKS_*` is the canonical prefix.
# - `HAPPY_LOCAL_*` is still supported as a legacy alias (via automatic mapping).

# -----------------------------------------------------------------------------
# Core (server)
# -----------------------------------------------------------------------------

# Main server URL shown/used by the CLI (QR/login links, etc).
# For local use: http://localhost:3005
# For Tailscale (recommended): set this to your HTTPS Serve URL, e.g. https://<machine>.<tailnet>.ts.net
HAPPY_STACKS_SERVER_URL=http://localhost:3005

# Server port (main stack)
HAPPY_STACKS_SERVER_PORT=3005

# Which server component to use by default:
# - happy-server-light (default)
# - happy-server
HAPPY_STACKS_SERVER_COMPONENT=happy-server-light

# -----------------------------------------------------------------------------
# Full server (happy-server) managed infra (Docker Compose)
# -----------------------------------------------------------------------------
#
# When running `happy-server`, happy-stacks can auto-start per-stack Postgres/Redis/Minio
# (local, free, S3-compatible; no AWS required) and wire DATABASE_URL/REDIS_URL/S3_*.
#
# Disable if you want to bring your own Postgres/Redis/S3:
# HAPPY_STACKS_MANAGED_INFRA=0
#
# Auto-apply Prisma migrations for happy-server on `happys dev/start` (non-interactive, idempotent):
# - runs: `prisma migrate deploy`
HAPPY_STACKS_PRISMA_MIGRATE=1
#
# If autostart is enabled and Docker Desktop may start slowly, happy-stacks will wait for Docker.
# Default: 0ms in TTY sessions, 60000ms in non-interactive (LaunchAgent/SwiftBar).
# HAPPY_STACKS_DOCKER_WAIT_MS=60000
#
# Best-effort: try to start Docker automatically if it's installed but not running.
# Default: enabled in non-interactive (services), disabled in interactive shells.
# HAPPY_STACKS_DOCKER_AUTOSTART=1
# Optional macOS override:
# HAPPY_STACKS_DOCKER_APP=/Applications/Docker.app
#
# happy-server runs behind a local gateway on the main stack port. The real backend server will
# bind to this port (stack-scoped env overrides will be written automatically for stacks):
# HAPPY_STACKS_HAPPY_SERVER_BACKEND_PORT=3015

# -----------------------------------------------------------------------------
# Server-light (happy-server-light) Prisma behavior
# -----------------------------------------------------------------------------
#
# In `happys dev` and `happys start`, happy-server-light uses deterministic Prisma migrations:
# - `prisma migrate deploy --schema prisma/sqlite/schema.prisma`
#
# Historical note:
# - Old server-light setups used `prisma db push`. Happy Stacks no longer uses db push for SQLite.
# - If you have an old SQLite DB created via db push, you may need to baseline it once so migrations can run.

# -----------------------------------------------------------------------------
# Expo / Metro dev server behavior (UI)
# -----------------------------------------------------------------------------
#
# In `happys dev`, `happys start --mobile`, and `happys mobile`, happy-stacks starts `expo start`.
# IMPORTANT: we enforce a single Expo dev server per stack/worktree (no separate "web" vs "mobile"
# Metro processes for the same stack).
#
# Expo host mode:
# - We default to LAN so phones can reach Metro on your Wiâ€‘Fi network.
# - Web UI still uses the stack-scoped `happy-<stack>.localhost` hostname for isolation.
#
# Allowed: lan | localhost | tunnel
# HAPPY_STACKS_EXPO_HOST=lan
#
# Optional: force the Expo dev server port (otherwise we auto-pick a free port).
# HAPPY_STACKS_EXPO_DEV_PORT=8081
#
# Default dev-client URL scheme used by Happy Stacks when running `--mobile`.
# This should match the scheme used by the installed "Happy Stacks Dev" dev-client app.
# HAPPY_STACKS_DEV_CLIENT_SCHEME=happystacks-dev
#
# Optional: override LAN IP detection (used to rewrite localhost server URLs for mobile).
# HAPPY_STACKS_LAN_IP=192.168.0.50
#
# Optional: storage isolation scope for native dev-client.
#
# When using a single installed dev-client app across multiple stacks, you can scope the app's
# persisted storage (SecureStore/MMKV) per stack to avoid token/server collisions.
#
# - If set, happy-stacks passes it through as `EXPO_PUBLIC_HAPPY_STORAGE_SCOPE`.
# - If unset, and you run stack-mode dev-client (`--mobile`), happy-stacks defaults it to the stack name.
#
# HAPPY_STACKS_STORAGE_SCOPE=pr272-107-fixes-2026-01-15
#
# To avoid cross-worktree Metro cache pollution in non-interactive runs (LLMs/services),
# we default to adding `--clear` when no TTY is present.
#
# - Set to 0 to never pass `--clear`
# - Set to 1 to always pass `--clear`
# HAPPY_STACKS_EXPO_CLEAR_CACHE=1

# -----------------------------------------------------------------------------
# What to run
# -----------------------------------------------------------------------------

# UI build + serving (when using happy-server-light)
HAPPY_STACKS_UI_PREFIX=/
HAPPY_STACKS_SERVE_UI=1

# Components
HAPPY_STACKS_UI=1
HAPPY_STACKS_DAEMON=1

# Setup behavior (bootstrap)
HAPPY_STACKS_NPM_LINK=1
HAPPY_STACKS_CLI_BUILD=1

# Init behavior
# - Set to 1 to persist skipping runtime installs when running `happys init`.
#   (Useful on dev machines where you always run from your repo checkout via HAPPY_STACKS_CLI_ROOT_DIR.)
# HAPPY_STACKS_INIT_NO_RUNTIME=1

# -----------------------------------------------------------------------------
# Storage / paths
# -----------------------------------------------------------------------------

# Canonical storage root for stacks (new):
HAPPY_STACKS_STORAGE_DIR=~/.happy/stacks

# Optional overrides for the main stack:
HAPPY_STACKS_UI_BUILD_DIR=~/.happy/stacks/main/ui
HAPPY_STACKS_CLI_HOME_DIR=~/.happy/stacks/main/cli

# When creating new stacks, auto-pick ports starting from here:
HAPPY_STACKS_STACK_PORT_START=3005

# -----------------------------------------------------------------------------
# Git cloning defaults (bootstrap)
# -----------------------------------------------------------------------------

# Default clone source for missing components:
# - forks (default)
# - upstream
HAPPY_STACKS_REPO_SOURCE=forks

# Optional: override repo URLs
# HAPPY_STACKS_UI_REPO_URL=
# HAPPY_STACKS_CLI_REPO_URL=
# HAPPY_STACKS_SERVER_LIGHT_REPO_URL=
# HAPPY_STACKS_SERVER_FULL_REPO_URL=

# Disable auto-cloning missing component repos:
# HAPPY_STACKS_CLONE_MISSING=0

# -----------------------------------------------------------------------------
# Tailscale Serve automation (optional)
# -----------------------------------------------------------------------------

# Optional: expose UI over HTTPS using Tailscale Serve (recommended for remote access)
HAPPY_STACKS_TAILSCALE_SERVE=0
HAPPY_STACKS_TAILSCALE_SERVE_PATH=/
HAPPY_STACKS_TAILSCALE_UPSTREAM=http://127.0.0.1:3005
HAPPY_STACKS_TAILSCALE_RESET_ON_EXIT=0
HAPPY_STACKS_TAILSCALE_PREFER_PUBLIC_URL=1

# Optional: how long `pnpm start` should wait for Tailscale at boot (ms)
HAPPY_STACKS_TAILSCALE_WAIT_MS=15000

# If `tailscale` is not on PATH (common if you use the macOS app), set this:
HAPPY_STACKS_TAILSCALE_BIN=/Applications/Tailscale.app/Contents/MacOS/Tailscale

# -----------------------------------------------------------------------------
# Worktree UX (optional)
# -----------------------------------------------------------------------------

# Preferred terminal / shell for `pnpm wt shell` and SwiftBar actions:
# HAPPY_STACKS_WT_TERMINAL=auto
# HAPPY_STACKS_WT_SHELL=/bin/zsh

# -----------------------------------------------------------------------------
# Tauri build (optional)
# -----------------------------------------------------------------------------

HAPPY_STACKS_BUILD_TAURI=0
HAPPY_STACKS_TAURI_DEBUG=1
HAPPY_STACKS_TAURI_IDENTIFIER=com.happy.stacks
HAPPY_STACKS_TAURI_PRODUCT_NAME="Happy Stacks"

# Optional overrides:
# HAPPY_STACKS_TAURI_SERVER_URL=
# HAPPY_STACKS_TAURI_PREFER_TAILSCALE=1

# -----------------------------------------------------------------------------
# Mobile app (iOS) (optional)
# -----------------------------------------------------------------------------
#
# These are used by `pnpm mobile:*` commands.
# Recommended if you plan to install a release build onto a real iPhone.
#
# - For real devices: use a bundle identifier you own (Apple dev portal).
# - `HAPPY_STACKS_SERVER_URL` is automatically baked into the app as EXPO_PUBLIC_HAPPY_SERVER_URL when building.
#
# Example:
# HAPPY_STACKS_IOS_BUNDLE_ID=com.yourname.happy.local.dev
# HAPPY_STACKS_IOS_APP_NAME="Happy Local"
#
# Optional: override how Metro is started / which scheme is used for QR launching:
# HAPPY_STACKS_MOBILE_HOST=lan
# HAPPY_STACKS_MOBILE_SCHEME=com.yourname.happy.local.dev
#
# Port note:
# - New (preferred): HAPPY_STACKS_EXPO_DEV_PORT
# - Legacy alias (still supported): HAPPY_STACKS_MOBILE_PORT
# HAPPY_STACKS_EXPO_DEV_PORT=8081

# -----------------------------------------------------------------------------
# Optional: server-light metrics (upstream component feature; not used by happy-stacks scripts)
# -----------------------------------------------------------------------------

METRICS_ENABLED=false
METRICS_PORT=9090


