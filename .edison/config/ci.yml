ci:
  commands:
    # IMPORTANT (Happy Stacks discipline):
    # - Evidence commands MUST run via `happys` (not raw pnpm/yarn/expo/tsc/docker).
    # - Evidence is expected to be stack-scoped (use `happys edison --stack=<name> ...`),
    #   which sets HAPPY_STACKS_STACK + HAPPY_STACKS_ENV_FILE for the commands below.
    # Task-frontmatter templating is supported (Edison fills {{stack}} / {{components_csv}} from the task file).
    # Fail-closed rules:
    # - If task has no stack, evidence capture must fail.
    # - If env stack is set (via happys edison --stack=...), it must match the task stack.
    # - If task declares components, pass them as positional args to stack-scoped commands.
    type-check: 'KIND="{{hs_kind}}"; if [ -z "$KIND" ] || [ "$KIND" = "parent" ]; then echo "Refusing evidence capture for hs_kind=parent. Run evidence on a track/component task."; exit 1; fi; TASK_STACK="{{stack}}"; TASK_STACK="${TASK_STACK%\"}"; TASK_STACK="${TASK_STACK#\"}"; ENV_STACK="${HAPPY_STACKS_STACK:?Run via: happys edison --stack=$TASK_STACK -- evidence capture <task-id>}"; if [ -z "$TASK_STACK" ]; then echo "Missing task stack (fill frontmatter: stack)"; exit 1; fi; if [ "$ENV_STACK" != "$TASK_STACK" ]; then echo "Stack mismatch: env=$ENV_STACK task=$TASK_STACK"; exit 1; fi; IFS="," read -r -a COMPS <<< "{{components_csv}}"; node ./bin/happys.mjs stack typecheck "$TASK_STACK" "${COMPS[@]}"'
    lint: 'KIND="{{hs_kind}}"; if [ -z "$KIND" ] || [ "$KIND" = "parent" ]; then echo "Refusing evidence capture for hs_kind=parent. Run evidence on a track/component task."; exit 1; fi; TASK_STACK="{{stack}}"; TASK_STACK="${TASK_STACK%\"}"; TASK_STACK="${TASK_STACK#\"}"; ENV_STACK="${HAPPY_STACKS_STACK:?Run via: happys edison --stack=$TASK_STACK -- evidence capture <task-id>}"; if [ -z "$TASK_STACK" ]; then echo "Missing task stack (fill frontmatter: stack)"; exit 1; fi; if [ "$ENV_STACK" != "$TASK_STACK" ]; then echo "Stack mismatch: env=$ENV_STACK task=$TASK_STACK"; exit 1; fi; IFS="," read -r -a COMPS <<< "{{components_csv}}"; node ./bin/happys.mjs stack lint "$TASK_STACK" "${COMPS[@]}"'
    build: 'KIND="{{hs_kind}}"; if [ -z "$KIND" ] || [ "$KIND" = "parent" ]; then echo "Refusing evidence capture for hs_kind=parent. Run evidence on a track/component task."; exit 1; fi; TASK_STACK="{{stack}}"; TASK_STACK="${TASK_STACK%\"}"; TASK_STACK="${TASK_STACK#\"}"; ENV_STACK="${HAPPY_STACKS_STACK:?Run via: happys edison --stack=$TASK_STACK -- evidence capture <task-id>}"; if [ -z "$TASK_STACK" ]; then echo "Missing task stack (fill frontmatter: stack)"; exit 1; fi; if [ "$ENV_STACK" != "$TASK_STACK" ]; then echo "Stack mismatch: env=$ENV_STACK task=$TASK_STACK"; exit 1; fi; OUT_DIR="$PWD/.edison/_tmp/ui-build/$TASK_STACK"; export HAPPY_LOCAL_UI_BUILD_DIR="$OUT_DIR"; COMPS_CSV="{{components_csv}}"; case ",$COMPS_CSV," in (*,happy,*) node ./bin/happys.mjs stack build "$TASK_STACK" ;; (*) node ./bin/happys.mjs stack build "$TASK_STACK" -- --no-ui ;; esac'
    test: 'KIND="{{hs_kind}}"; if [ -z "$KIND" ] || [ "$KIND" = "parent" ]; then echo "Refusing evidence capture for hs_kind=parent. Run evidence on a track/component task."; exit 1; fi; TASK_STACK="{{stack}}"; TASK_STACK="${TASK_STACK%\"}"; TASK_STACK="${TASK_STACK#\"}"; ENV_STACK="${HAPPY_STACKS_STACK:?Run via: happys edison --stack=$TASK_STACK -- evidence capture <task-id>}"; if [ -z "$TASK_STACK" ]; then echo "Missing task stack (fill frontmatter: stack)"; exit 1; fi; if [ "$ENV_STACK" != "$TASK_STACK" ]; then echo "Stack mismatch: env=$ENV_STACK task=$TASK_STACK"; exit 1; fi; IFS="," read -r -a COMPS <<< "{{components_csv}}"; node ./bin/happys.mjs stack test "$TASK_STACK" "${COMPS[@]}"'
    track-coherence: 'KIND="{{hs_kind}}"; if [ -z "$KIND" ] || [ "$KIND" = "parent" ]; then echo "Refusing evidence capture for hs_kind=parent. Run evidence on a track/component task."; exit 1; fi; TASK_STACK="{{stack}}"; TASK_STACK="${TASK_STACK%\"}"; TASK_STACK="${TASK_STACK#\"}"; ENV_STACK="${HAPPY_STACKS_STACK:?Run via: happys edison --stack=$TASK_STACK -- evidence capture <task-id>}"; if [ -z "$TASK_STACK" ]; then echo "Missing task stack (fill frontmatter: stack)"; exit 1; fi; if [ "$ENV_STACK" != "$TASK_STACK" ]; then echo "Stack mismatch: env=$ENV_STACK task=$TASK_STACK"; exit 1; fi; node ./bin/happys.mjs edison track:coherence "{{task_id}}" --source=upstream --targets=fork,integration --json --max-lines=80'

  # Optional baseline multi-repo fingerprint inputs.
  # Happy Stacks wrappers (`happys edison --stack=...`) will override these at runtime to include
  # the stackâ€™s resolved component repo paths + the stack env file itself.
  fingerprint:
    git_roots:
      - "."
    extra_files: []
