validation:
  # Happy Stacks evidence policy:
  # - "fast" preset: type-check + build + lint (good for UI iteration)
  # - "standard" preset: fast + tests
  #
  # IMPORTANT: command evidence is generated via `edison evidence capture <task-id>`
  # and is expected to run through `happys` wrappers (see .edison/config/ci.yml).

  # Default to the fast preset; validators/QA can opt into "standard" per task when needed.
  defaultPreset: fast

  presets:
    quick:
      name: quick
      description: "Docs/config-only changes (no command evidence required)"
      required_evidence: []
      validators: []

    fast:
      name: fast
      description: "Typecheck + build + lint (stack-scoped)"
      required_evidence:
        - command-type-check.txt
        - command-build.txt
        - command-lint.txt
        - command-track-coherence.txt
      validators:
        - track-drift-review
      blocking_validators:
        - track-drift-review

    standard:
      name: standard
      description: "Fast + tests (stack-scoped)"
      required_evidence:
        - command-type-check.txt
        - command-build.txt
        - command-lint.txt
        - command-test.txt
        - command-track-coherence.txt
        - command-task-diff.txt
      validators:
        - track-drift-review
      blocking_validators:
        - track-drift-review

    # Validation-only preset: includes CodeRabbit review evidence.
    #
    # IMPORTANT:
    # - Use this preset when you intend to *validate* / promote a task.
    # - Do NOT use this preset for routine implementation evidence capture; it is heavier.
    standard-validate:
      name: standard-validate
      description: "Standard + CodeRabbit review (validation-only, stack-scoped)"
      required_evidence:
        - command-type-check.txt
        - command-build.txt
        - command-lint.txt
        - command-test.txt
        - command-track-coherence.txt
        - command-task-diff.txt
        - command-coderabbit.txt
      validators:
        - track-drift-review
      blocking_validators:
        - track-drift-review

    fast-ui:
      name: fast-ui
      description: "Fast + browser UI validation (for tasks that include component happy)"
      required_evidence:
        - command-type-check.txt
        - command-build.txt
        - command-lint.txt
        - command-track-coherence.txt
      validators:
        - browser-e2e
        - track-drift-review
      blocking_validators:
        - browser-e2e
        - track-drift-review

    standard-ui:
      name: standard-ui
      description: "Standard + browser UI validation (for tasks that include component happy)"
      required_evidence:
        - command-type-check.txt
        - command-build.txt
        - command-lint.txt
        - command-test.txt
        - command-track-coherence.txt
        - command-task-diff.txt
      validators:
        - browser-e2e
        - track-drift-review
      blocking_validators:
        - browser-e2e
        - track-drift-review

    # Validation-only preset for UI tasks: includes CodeRabbit review evidence.
    standard-ui-validate:
      name: standard-ui-validate
      description: "Standard UI + CodeRabbit review (validation-only, stack-scoped)"
      required_evidence:
        - command-type-check.txt
        - command-build.txt
        - command-lint.txt
        - command-test.txt
        - command-track-coherence.txt
        - command-task-diff.txt
        - command-coderabbit.txt
      validators:
        - browser-e2e
        - track-drift-review
      blocking_validators:
        - browser-e2e
        - track-drift-review

  presetInference:
    rules:
      - patterns:
          - "docs/**"
          - "*.md"
          - "**/*.md"
          - "LICENSE"
          - "LICENSE.*"
        preset: quick
        priority: 10

  evidence:
    # Baseline required evidence for tasks when preset does not override it.
    requiredFiles:
      - command-type-check.txt
      - command-build.txt
      - command-lint.txt
      - command-track-coherence.txt
    # Command name -> evidence filename mapping (used by evidence capture filtering).
    files:
      type-check: command-type-check.txt
      lint: command-lint.txt
      test: command-test.txt
      build: command-build.txt
      track-coherence: command-track-coherence.txt
      task-diff: command-task-diff.txt
      coderabbit: command-coderabbit.txt

  # Optional web server profiles for validators that need a running stack.
  #
  # IMPORTANT:
  # - These profiles rely on running Edison via `happys edison --stack=<name> -- ...`
  #   so the stack env (including HAPPY_LOCAL_SERVER_PORT / HAPPY_STACKS_SERVER_PORT) is loaded.
  web_servers:
    happy-stack: &happy_stack
      # Use stack-scoped *.localhost hostnames for origin isolation (prevents browser state leakage
      # across stacks even if ports are reused later).
      url: "http://${HAPPY_STACKS_LOCALHOST_HOST}:${HAPPY_LOCAL_SERVER_PORT}"
      # IMPORTANT:
      # Use 127.0.0.1 for health probing to avoid hostname-specific resolver/IPv6 edge cases.
      # The browser validator still navigates to `url` (stack-scoped hostname) for origin isolation.
      healthcheck_url: "http://127.0.0.1:${HAPPY_LOCAL_SERVER_PORT}/health"
      ensure_running: true
      stop_after: true
      start:
        command: "node ./bin/happys.mjs stack start \"$HAPPY_STACKS_STACK\""
      stop:
        # Stop only when Edison started the stack.
        #
        # NOTE: `edison` tracks `started_by_us` separately from `process_pid`.
        # `happys stack start` may exit after launching background processes; we still
        # want to run stop when `started_by_us=true`.
        run_even_if_no_process: true
        command: "node ./bin/happys.mjs stack stop \"$HAPPY_STACKS_STACK\" --yes"

    # Alias for the `e2e-web` pack's expected profile name.
    browser-e2e:
      <<: *happy_stack

  validators:
    # Happy-local wiring: bind browser-e2e to the Happy Stacks web server profile.
    # Prompt comes from the `e2e-web` pack (MCP-only) plus `.edison/validators/overlays/browser-e2e.md`.
    browser-e2e:
      web_server:
        ref: browser-e2e

    # Cross-track drift review (Happy Stacks).
    #
    # Lightweight: it reviews drift between tracks (upstream vs fork/integration) using
    # `happys edison track:coherence` output and git diffs/range-diff.
    #
    # Included in `fast`, `standard`, `fast-ui`, and `standard-ui` as a mandatory blocking check.
    track-drift-review:
      name: "Track Drift Review (Happy Stacks)"
      engine: codex-cli
      fallback_engine: pal-mcp
      prompt: ".edison/validators/track-drift-review.md"
      wave: comprehensive
      always_run: false
      blocking: true
      timeout: 6000

    # CodeRabbit is captured as stack-scoped, per-component command evidence (`command-coderabbit.txt`)
    # so it runs against the correct component repos/bases for multi-component tasks.
