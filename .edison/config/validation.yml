validation:
  # Happy Stacks evidence policy:
  # - "fast" preset: type-check + build + lint (good for UI iteration)
  # - "standard" preset: fast + tests
  #
  # IMPORTANT: command evidence is generated via `edison evidence capture <task-id>`
  # and is expected to run through `happys` wrappers (see .edison/config/ci.yml).

  # Default to the fast preset; validators/QA can opt into "standard" per task when needed.
  defaultPreset: fast

  presets:
    quick:
      name: quick
      description: "Docs/config-only changes (no command evidence required)"
      required_evidence: []
      validators: []

    fast:
      name: fast
      description: "Typecheck + build + lint (stack-scoped) + browser UI validation"
      required_evidence:
        - command-type-check.txt
        - command-build.txt
        - command-lint.txt
      validators:
        - browser-e2e

    standard:
      name: standard
      description: "Fast + tests (stack-scoped) + browser UI validation"
      required_evidence:
        - command-type-check.txt
        - command-build.txt
        - command-lint.txt
        - command-test.txt
      validators:
        - browser-e2e

  presetInference:
    rules:
      - patterns:
          - "docs/**"
          - "*.md"
          - "**/*.md"
          - "LICENSE"
          - "LICENSE.*"
        preset: quick
        priority: 10

  evidence:
    # Baseline required evidence for tasks when preset does not override it.
    requiredFiles:
      - command-type-check.txt
      - command-build.txt
      - command-lint.txt
    # Command name -> evidence filename mapping (used by evidence capture filtering).
    files:
      type-check: command-type-check.txt
      lint: command-lint.txt
      test: command-test.txt
      build: command-build.txt

  # Optional web server profiles for validators that need a running stack.
  #
  # IMPORTANT:
  # - These profiles rely on running Edison via `happys edison --stack=<name> -- ...`
  #   so the stack env (including HAPPY_LOCAL_SERVER_PORT / HAPPY_STACKS_SERVER_PORT) is loaded.
  web_servers:
    happy-stack: &happy_stack
      url: "http://127.0.0.1:${HAPPY_LOCAL_SERVER_PORT}"
      healthcheck_url: "http://127.0.0.1:${HAPPY_LOCAL_SERVER_PORT}/health"
      ensure_running: true
      stop_after: true
      start:
        command: "node ./bin/happys.mjs stack start \"$HAPPY_STACKS_STACK\""
      stop:
        # Stop only when Edison started the stack.
        #
        # NOTE: `edison` tracks `started_by_us` separately from `process_pid`.
        # `happys stack start` may exit after launching background processes; we still
        # want to run stop when `started_by_us=true`.
        run_even_if_no_process: true
        command: "node ./bin/happys.mjs stack stop \"$HAPPY_STACKS_STACK\" --yes"

    # Alias for the `e2e-web` pack's expected profile name.
    browser-e2e:
      <<: *happy_stack

  validators:
    # Happy-local wiring: bind browser-e2e to the Happy Stacks web server profile.
    # Prompt comes from the `e2e-web` pack (MCP-only) plus `.edison/validators/overlays/browser-e2e.md`.
    browser-e2e:
      web_server:
        ref: browser-e2e
